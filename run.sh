#!/bin/bash

# ะกะบัะธะฟั ะทะฐะฟััะบะฐ ะฑะพัะฐ ะดะปั ะธะฝัะตัะฝะตั-ะฟัะพะฒะฐะนะดะตัะฐ

echo "๐ ะะฐะฟััะบ ะฑะพัะฐ..."

# ะะตัะตัะพะด ะฒ ะดะธัะตะบัะพัะธั ัะพ ัะบัะธะฟัะพะผ
cd "$(dirname "$0")"

# ะัะพะฒะตัะบะฐ ะฝะฐะปะธัะธั .env ัะฐะนะปะฐ
if [ ! -f .env ]; then
    echo "โ ะัะธะฑะบะฐ: ัะฐะนะป .env ะฝะต ะฝะฐะนะดะตะฝ"
    echo "๐ ะกะพะทะดะฐะนัะต ัะฐะนะป .env ะฝะฐ ะพัะฝะพะฒะต .env.example"
    exit 1
fi

# ะัะพะฒะตัะบะฐ ะฝะฐะปะธัะธั ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั
if [ ! -d "venv" ]; then
    echo "โ๏ธ  ะะธัััะฐะปัะฝะพะต ะพะบััะถะตะฝะธะต ะฝะต ะฝะฐะนะดะตะฝะพ"
    echo "๐ฆ ะกะพะทะดะฐะฝะธะต ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั..."
    python3 -m venv venv
    
    if [ $? -ne 0 ]; then
        echo "โ ะัะธะฑะบะฐ ะฟัะธ ัะพะทะดะฐะฝะธะธ ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั"
        exit 1
    fi
fi

# ะะบัะธะฒะฐัะธั ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั
echo "๐ง ะะบัะธะฒะฐัะธั ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั..."
source venv/bin/activate

# ะัะพะฒะตัะบะฐ ะธ ัััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน
echo "๐ฆ ะัะพะฒะตัะบะฐ ะทะฐะฒะธัะธะผะพััะตะน..."
pip install -q -r requirements.txt

if [ $? -ne 0 ]; then
    echo "โ ะัะธะฑะบะฐ ะฟัะธ ัััะฐะฝะพะฒะบะต ะทะฐะฒะธัะธะผะพััะตะน"
    exit 1
fi

# ะัะพะฒะตัะบะฐ, ะฝะต ะทะฐะฟััะตะฝ ะปะธ ัะถะต ะฑะพั
if pgrep -f "python.*bot.py" > /dev/null; then
    echo "โ๏ธ  ะะพั ัะถะต ะทะฐะฟััะตะฝ"
    echo "๐ PID: $(pgrep -f 'python.*bot.py')"
    read -p "โ ะะตัะตะทะฐะฟัััะธัั ะฑะพัะฐ? (y/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo "โน๏ธ  ะััะฐะฝะพะฒะบะฐ ะฑะพัะฐ..."
        pkill -f "python.*bot.py"
        sleep 2
    else
        echo "โ ะะฐะฟััะบ ะพัะผะตะฝะตะฝ"
        exit 0
    fi
fi

# ะะฐะฟััะบ ะฑะพัะฐ
echo "โ ะะฐะฟััะบ ะฑะพัะฐ..."
nohup python bot.py > bot.log 2>&1 &

# ะะพะปััะตะฝะธะต PID
BOT_PID=$!

# ะะตะฑะพะปััะฐั ะฟะฐัะทะฐ ะดะปั ะฟัะพะฒะตัะบะธ ะทะฐะฟััะบะฐ
sleep 2

# ะัะพะฒะตัะบะฐ, ััะพ ะฑะพั ะทะฐะฟัััะธะปัั
if ps -p $BOT_PID > /dev/null 2>&1; then
    echo "โ ะะพั ััะฟะตัะฝะพ ะทะฐะฟััะตะฝ!"
    echo "๐ข PID: $BOT_PID"
    echo "๐ ะะพะณะธ: tail -f bot.log"
    echo ""
    echo "ะะปั ะพััะฐะฝะพะฒะบะธ: pkill -f 'python.*bot.py'"
else
    echo "โ ะัะธะฑะบะฐ ะทะฐะฟััะบะฐ ะฑะพัะฐ"
    echo "๐ ะัะพะฒะตัััะต ะปะพะณะธ: cat bot.log"
    exit 1
fi
